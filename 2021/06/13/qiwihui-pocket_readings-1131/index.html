<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pocket.qiwihui.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Async&#x2F;await">
<meta property="og:type" content="article">
<meta property="og:title" content="Async&#x2F;await">
<meta property="og:url" content="http://pocket.qiwihui.com/2021/06/13/qiwihui-pocket_readings-1131/index.html">
<meta property="og:site_name" content="Pocket Readings">
<meta property="og:description" content="Async&#x2F;await">
<meta property="article:published_time" content="2021-06-13T10:21:34.000Z">
<meta property="article:modified_time" content="2021-07-21T13:58:31.410Z">
<meta property="article:author" content="qiwihui">
<meta property="article:tag" content="fetched">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://pocket.qiwihui.com/2021/06/13/qiwihui-pocket_readings-1131/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Async/await | Pocket Readings</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pocket Readings</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">个人阅读清单记录博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://pocket.qiwihui.com/2021/06/13/qiwihui-pocket_readings-1131/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiwihui">
      <meta itemprop="description" content="个人阅读清单记录博客，并不代表个人观点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pocket Readings">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Async/await
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-13 10:21:34" itemprop="dateCreated datePublished" datetime="2021-06-13T10:21:34+00:00">2021-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-21 13:58:31" itemprop="dateModified" datetime="2021-07-21T13:58:31+00:00">2021-07-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/2019%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">2019阅读</span></a>
                </span>
            </span>

          
            <div class="post-description">Async/await</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>There&rsquo;s a special syntax to work with promises in a more comfortable fashion, called &ldquo;async/await&rdquo;. It&rsquo;s surprisingly easy to understand and use. Let&rsquo;s start with the async keyword. It can be placed before a function, like this:<br><br><br><br>Tags:<br><br><br><br>via Pocket <a href="https://ift.tt/2TlRdOi" target="_blank" rel="noopener">https://ift.tt/2TlRdOi</a> original site<br><br><br><br>June 13, 2021 at 05:27PM</p>
<h3 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h3><hr>
<blockquote>
<p>from: <a href="https://github.com/qiwihui/pocket_readings/issues/1131#issuecomment-860187489" target="_blank" rel="noopener"><strong>github-actions[bot]</strong></a> on: <strong>6/13/2021</strong></p>
</blockquote>
<h2 id="Async-await-by-iliakan"><a href="#Async-await-by-iliakan" class="headerlink" title="Async/await by @iliakan"></a>Async/await by @iliakan</h2><p>There’s a special syntax to work with promises in a more comfortable fashion, called “async/await”. It’s surprisingly easy to understand and use.</p>
<h2 id="Async-functions"><a href="#Async-functions" class="headerlink" title="Async functions"></a><a href="https://javascript.info/#async-functions" target="_blank" rel="noopener">Async functions</a></h2><p>Let’s start with the <code>async</code> keyword. It can be placed before a function, like this:</p>
<pre><code>async function f() {
  return 1;
}</code></pre><p>The word “async” before a function means one simple thing: a function always returns a promise. Other values are wrapped in a resolved promise automatically.</p>
<p>For instance, this function returns a resolved promise with the result of <code>1</code>; let’s test it:</p>
<pre><code>async function f() {
  return 1;
}

f().then(alert); // 1</code></pre><p>…We could explicitly return a promise, which would be the same:</p>
<pre><code>async function f() {
  return Promise.resolve(1);
}

f().then(alert); // 1</code></pre><p>So, <code>async</code> ensures that the function returns a promise, and wraps non-promises in it. Simple enough, right? But not only that. There’s another keyword, <code>await</code>, that works only inside <code>async</code> functions, and it’s pretty cool.</p>
<h2 id="Await"><a href="#Await" class="headerlink" title="Await"></a><a href="https://javascript.info/#await" target="_blank" rel="noopener">Await</a></h2><p>The syntax:</p>
<pre><code>// works only inside async functions
let value = await promise;</code></pre><p>The keyword <code>await</code> makes JavaScript wait until that promise settles and returns its result.</p>
<p>Here’s an example with a promise that resolves in 1 second:</p>
<pre><code>async function f() {

  let promise = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; resolve(&quot;done!&quot;), 1000)
  });

  let result = await promise; // wait until the promise resolves (*)

  alert(result); // &quot;done!&quot;
}

f();</code></pre><p>The function execution “pauses” at the line <code>(*)</code> and resumes when the promise settles, with <code>result</code> becoming its result. So the code above shows “done!” in one second.</p>
<p>Let’s emphasize: <code>await</code> literally suspends the function execution until the promise settles, and then resumes it with the promise result. That doesn’t cost any CPU resources, because the JavaScript engine can do other jobs in the meantime: execute other scripts, handle events, etc.</p>
<p>It’s just a more elegant syntax of getting the promise result than <code>promise.then</code>. And, it’s easier to read and write.</p>
<p>Can’t use <code>await</code> in regular functions</p>
<p>If we try to use <code>await</code> in a non-async function, there would be a syntax error:</p>
<pre><code>function f() {
  let promise = Promise.resolve(1);
  let result = await promise; // Syntax error
}</code></pre><p>We may get this error if we forget to put <code>async</code> before a function. As stated earlier, <code>await</code> only works inside an <code>async</code> function.</p>
<p>Let’s take the <code>showAvatar()</code> example from the chapter <a href="https://javascript.info/promise-chaining" target="_blank" rel="noopener">Promises chaining</a> and rewrite it using <code>async/await</code>:</p>
<ol>
<li><p>We’ll need to replace <code>.then</code> calls with <code>await</code>.</p>
</li>
<li><p>Also we should make the function <code>async</code> for them to work.</p>
<p>async function showAvatar() {</p>
<p>  // read our JSON<br>  let response = await fetch(‘/article/promise-chaining/user.json’);<br>  let user = await response.json();</p>
<p>  // read github user<br>  let githubResponse = await fetch(<code>https://api.github.com/users/${user.name}</code>);<br>  let githubUser = await githubResponse.json();</p>
<p>  // show the avatar<br>  let img = document.createElement(‘img’);<br>  img.src = githubUser.avatar_url;<br>  img.className = “promise-avatar-example”;<br>  document.body.append(img);</p>
<p>  // wait 3 seconds<br>  await new Promise((resolve, reject) =&gt; setTimeout(resolve, 3000));</p>
<p>  img.remove();</p>
<p>  return githubUser;<br>}</p>
<p>showAvatar();</p>
</li>
</ol>
<p>Pretty clean and easy to read, right? Much better than before.</p>
<p><code>await</code> won’t work in the top-level code</p>
<p>People who are just starting to use <code>await</code> tend to forget the fact that we can’t use <code>await</code> in top-level code. For example, this will not work:</p>
<pre><code>// syntax error in top-level code
let response = await fetch(&apos;/article/promise-chaining/user.json&apos;);
let user = await response.json();</code></pre><p>But we can wrap it into an anonymous async function, like this:</p>
<pre><code>(async () =&gt; {
  let response = await fetch(&apos;/article/promise-chaining/user.json&apos;);
  let user = await response.json();
  ...
})();</code></pre><p>P.S. New feature: starting from V8 engine version 8.9+, top-level await works in <a href="https://javascript.info/modules" target="_blank" rel="noopener">modules</a>.</p>
<p><code>await</code> accepts “thenables”</p>
<p>Like <code>promise.then</code>, <code>await</code> allows us to use thenable objects (those with a callable <code>then</code> method). The idea is that a third-party object may not be a promise, but promise-compatible: if it supports <code>.then</code>, that’s enough to use it with <code>await</code>.</p>
<p>Here’s a demo <code>Thenable</code> class; the <code>await</code> below accepts its instances:</p>
<pre><code>class Thenable {
  constructor(num) {
    this.num = num;
  }
  then(resolve, reject) {
    alert(resolve);
    // resolve with this.num*2 after 1000ms
    setTimeout(() =&gt; resolve(this.num * 2), 1000); // (*)
  }
}

async function f() {
  // waits for 1 second, then result becomes 2
  let result = await new Thenable(1);
  alert(result);
}

f();</code></pre><p>If <code>await</code> gets a non-promise object with <code>.then</code>, it calls that method providing the built-in functions <code>resolve</code> and <code>reject</code> as arguments (just as it does for a regular <code>Promise</code> executor). Then <code>await</code> waits until one of them is called (in the example above it happens in the line <code>(*)</code>) and then proceeds with the result.</p>
<p>Async class methods</p>
<p>To declare an async class method, just prepend it with <code>async</code>:</p>
<pre><code>class Waiter {
  async wait() {
    return await Promise.resolve(1);
  }
}

new Waiter()
  .wait()
  .then(alert); // 1 (this is the same as (result =&gt; alert(result)))</code></pre><p>The meaning is the same: it ensures that the returned value is a promise and enables <code>await</code>.</p>
<h2 id="Error-handling"><a href="#Error-handling" class="headerlink" title="Error handling"></a><a href="https://javascript.info/#error-handling" target="_blank" rel="noopener">Error handling</a></h2><p>If a promise resolves normally, then <code>await promise</code> returns the result. But in the case of a rejection, it throws the error, just as if there were a <code>throw</code> statement at that line.</p>
<p>This code:</p>
<pre><code>async function f() {
  await Promise.reject(new Error(&quot;Whoops!&quot;));
}</code></pre><p>…is the same as this:</p>
<pre><code>async function f() {
  throw new Error(&quot;Whoops!&quot;);
}</code></pre><p>In real situations, the promise may take some time before it rejects. In that case there will be a delay before <code>await</code> throws an error.</p>
<p>We can catch that error using <code>try..catch</code>, the same way as a regular <code>throw</code>:</p>
<pre><code>async function f() {

  try {
    let response = await fetch(&apos;http://no-such-url&apos;);
  } catch(err) {
    alert(err); // TypeError: failed to fetch
  }
}

f();</code></pre><p>In the case of an error, the control jumps to the <code>catch</code> block. We can also wrap multiple lines:</p>
<pre><code>async function f() {

  try {
    let response = await fetch(&apos;/no-user-here&apos;);
    let user = await response.json();
  } catch(err) {
    // catches errors both in fetch and response.json
    alert(err);
  }
}

f();</code></pre><p>If we don’t have <code>try..catch</code>, then the promise generated by the call of the async function <code>f()</code> becomes rejected. We can append <code>.catch</code> to handle it:</p>
<pre><code>async function f() {
  let response = await fetch(&apos;http://no-such-url&apos;);
}

// f() becomes a rejected promise
f().catch(alert); // TypeError: failed to fetch // (*)</code></pre><p>If we forget to add <code>.catch</code> there, then we get an unhandled promise error (viewable in the console). We can catch such errors using a global <code>unhandledrejection</code> event handler as described in the chapter <a href="https://javascript.info/promise-error-handling" target="_blank" rel="noopener">Error handling with promises</a>.</p>
<p><code>async/await</code> and <code>promise.then/catch</code></p>
<p>When we use <code>async/await</code>, we rarely need <code>.then</code>, because <code>await</code> handles the waiting for us. And we can use a regular <code>try..catch</code> instead of <code>.catch</code>. That’s usually (but not always) more convenient.</p>
<p>But at the top level of the code, when we’re outside any <code>async</code> function, we’re syntactically unable to use <code>await</code>, so it’s a normal practice to add <code>.then/catch</code> to handle the final result or falling-through error, like in the line <code>(*)</code> of the example above.</p>
<p><code>async/await</code> works well with <code>Promise.all</code></p>
<p>When we need to wait for multiple promises, we can wrap them in <code>Promise.all</code> and then <code>await</code>:</p>
<pre><code>// wait for the array of results
let results = await Promise.all([
  fetch(url1),
  fetch(url2),
  ...
]);</code></pre><p>In the case of an error, it propagates as usual, from the failed promise to <code>Promise.all</code>, and then becomes an exception that we can catch using <code>try..catch</code> around the call.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a><a href="https://javascript.info/#summary" target="_blank" rel="noopener">Summary</a></h2><p>The <code>async</code> keyword before a function has two effects:</p>
<ol>
<li>Makes it always return a promise.</li>
<li>Allows <code>await</code> to be used in it.</li>
</ol>
<p>The <code>await</code> keyword before a promise makes JavaScript wait until that promise settles, and then:</p>
<ol>
<li>If it’s an error, the exception is generated — same as if <code>throw error</code> were called at that very place.</li>
<li>Otherwise, it returns the result.</li>
</ol>
<p>Together they provide a great framework to write asynchronous code that is easy to both read and write.</p>
<p>With <code>async/await</code> we rarely need to write <code>promise.then/catch</code>, but we still shouldn’t forget that they are based on promises, because sometimes (e.g. in the outermost scope) we have to use these methods. Also <code>Promise.all</code> is nice when we are waiting for many tasks simultaneously.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/fetched/" rel="tag"># fetched</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/13/qiwihui-pocket_readings-1130/" rel="prev" title="


复旦邱锡鹏组最新综述：A Survey of Transformers！ ">
      <i class="fa fa-chevron-left"></i> 


复旦邱锡鹏组最新综述：A Survey of Transformers！ 
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/15/qiwihui-pocket_readings-1132/" rel="next" title="io_uring 的接口与实现">
      io_uring 的接口与实现 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Comments"><span class="nav-number">1.</span> <span class="nav-text">Comments</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Async-await-by-iliakan"><span class="nav-number"></span> <span class="nav-text">Async&#x2F;await by @iliakan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Async-functions"><span class="nav-number"></span> <span class="nav-text">Async functions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Await"><span class="nav-number"></span> <span class="nav-text">Await</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-handling"><span class="nav-number"></span> <span class="nav-text">Error handling</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number"></span> <span class="nav-text">Summary</span></a></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">qiwihui</p>
  <div class="site-description" itemprop="description">个人阅读清单记录博客，并不代表个人观点。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qiwihui</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
