<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pocket.qiwihui.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Pod terminating">
<meta property="og:type" content="article">
<meta property="og:title" content="Pod terminating">
<meta property="og:url" content="http://pocket.qiwihui.com/2021/03/17/qiwihui-pocket_readings-1049/index.html">
<meta property="og:site_name" content="Pocket Readings">
<meta property="og:description" content="Pod terminating">
<meta property="og:image" content="https://www.likakuli.com/svg/loading.min.svg">
<meta property="og:image" content="https://www.likakuli.com/svg/loading.min.svg">
<meta property="og:image" content="https://www.likakuli.com/media/reward/wechat.jpg">
<meta property="article:published_time" content="2021-03-17T03:21:15.000Z">
<meta property="article:modified_time" content="2021-07-21T13:58:31.426Z">
<meta property="article:author" content="qiwihui">
<meta property="article:tag" content="fetched">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.likakuli.com/svg/loading.min.svg">

<link rel="canonical" href="http://pocket.qiwihui.com/2021/03/17/qiwihui-pocket_readings-1049/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Pod terminating | Pocket Readings</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pocket Readings</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">个人阅读清单记录博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://pocket.qiwihui.com/2021/03/17/qiwihui-pocket_readings-1049/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiwihui">
      <meta itemprop="description" content="个人阅读清单记录博客，并不代表个人观点。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pocket Readings">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Pod terminating
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-17 03:21:15" itemprop="dateCreated datePublished" datetime="2021-03-17T03:21:15+00:00">2021-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-07-21 13:58:31" itemprop="dateModified" datetime="2021-07-21T13:58:31+00:00">2021-07-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/2019%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">2019阅读</span></a>
                </span>
            </span>

          
            <div class="post-description">Pod terminating</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&#36817;&#26399;&#65292;&#24377;&#24615;&#20113;&#32447;&#19978;&#38598;&#32676;&#21457;&#29983;&#20102;&#20960;&#36215;&#29305;&#27530;&#30340;&#23481;&#22120;&#28418;&#31227;&#22833;&#36133;&#20107;&#20214;&#65292;&#20854;&#29305;&#27530;&#20043;&#22788;&#22312;&#20110;&#23481;&#22120;&#22788;&#20110;Pod Terminating&#29366;&#24577;&#65292;&#32780;&#23487;&#20027;&#21017;&#22788;&#20110;Ready&#29366;&#24577;&#12290;<br><br><br><br>Tags: engineering<br><br><br><br>via Pocket <a href="https://ift.tt/3qV9Un8" target="_blank" rel="noopener">https://ift.tt/3qV9Un8</a> original site<br><br><br><br>March 17, 2021 at 10:42AM</p>
<h3 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h3><hr>
<blockquote>
<p>from: <a href="https://github.com/qiwihui/pocket_readings/issues/1049#issuecomment-800762929" target="_blank" rel="noopener"><strong>github-actions[bot]</strong></a> on: <strong>3/17/2021</strong></p>
</blockquote>
<h2 id="Pod-terminating"><a href="#Pod-terminating" class="headerlink" title="Pod terminating"></a>Pod terminating</h2><h1 id="Pod-terminating-1"><a href="#Pod-terminating-1" class="headerlink" title="Pod terminating"></a>Pod terminating</h1><p><a href="https://www.likakuli.com/" target="_blank" rel="noopener">Kaku Li</a> 收录于 <a href="https://www.likakuli.com/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" target="_blank" rel="noopener">问题排查</a></p>
<p> 2020-10-31  约 4140 字   预计阅读 9 分钟  次阅读  </p>
<p>目录</p>
<ul>
<li><ul>
<li><ul>
<li><a href="https://www.likakuli.com/#1-%E8%83%8C%E6%99%AF" target="_blank" rel="noopener">1. 背景</a></li>
<li><a href="https://www.likakuli.com/#2-%E6%8A%BD%E4%B8%9D%E5%89%A5%E8%8C%A7" target="_blank" rel="noopener">2. 抽丝剥茧</a><ul>
<li><a href="https://www.likakuli.com/#21-%E6%8E%92%E9%99%A4kubelet%E5%AB%8C%E7%96%91" target="_blank" rel="noopener">2.1 排除kubelet嫌疑</a></li>
<li><a href="https://www.likakuli.com/#22-google%E5%A4%A7%E6%B3%95" target="_blank" rel="noopener">2.2 Google大法</a></li>
<li><a href="https://www.likakuli.com/#23-docker%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener">2.3 docker处理流程</a></li>
<li><a href="https://www.likakuli.com/#24-%E6%8F%90%E5%AE%A1docker" target="_blank" rel="noopener">2.4 提审docker</a></li>
<li><a href="https://www.likakuli.com/#25-%E4%B8%80%E6%B3%A2%E5%8F%88%E8%B5%B7" target="_blank" rel="noopener">2.5 一波又起</a></li>
</ul>
</li>
<li><a href="https://www.likakuli.com/#3-%E9%97%AE%E9%A2%98%E5%BD%B1%E5%93%8D" target="_blank" rel="noopener">3. 问题影响</a></li>
<li><a href="https://www.likakuli.com/#4-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" target="_blank" rel="noopener">4. 解决方案</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>转载自组内同事stupig</p>
</blockquote>
<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>近期，弹性云线上集群发生了几起特殊的容器漂移失败事件，其特殊之处在于容器处于Pod Terminating状态，而宿主则处于Ready状态。</p>
<p>宿主状态为Ready说明其能够正常处理Pod事件，但是Pod却卡在了退出阶段，说明此问题并非由kubelet引起，那么docker就是1号犯罪嫌疑人了。</p>
<p>下文将详细介绍问题的排查与分析全过程。</p>
<h3 id="2-抽丝剥茧"><a href="#2-抽丝剥茧" class="headerlink" title="2. 抽丝剥茧"></a>2. 抽丝剥茧</h3><h4 id="2-1-排除kubelet嫌疑"><a href="#2-1-排除kubelet嫌疑" class="headerlink" title="2.1 排除kubelet嫌疑"></a>2.1 排除kubelet嫌疑</h4><p>Pod状态如下：</p>
<pre><code>1
2


[stupig@ master ~]$ kubectl get pod -owide
pod-976a0-5              0/1     Terminating        0          112m</code></pre><p>尽管kubelet的犯罪嫌疑已经很小，但是我们还是需要排查kubelet日志进一步确认。截取kubelet关键日志片段如下：</p>
<pre><code>1
2
3


I1014 10:56:46.492682   34976 kubelet_pods.go:1017] Pod &quot;pod-976a0-5_default(f1e03a3d-0dc7-11eb-b4b1-246e967c4efc)&quot; is terminated, but some containers have not been cleaned up: {ID:{Type:docker ID:41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef} Name:stupig State:exited CreatedAt:2020-10-14 10:49:57.859913657 +0800 CST StartedAt:2020-10-14 10:49:57.928654495 +0800 CST FinishedAt:2020-10-14 10:50:28.661263065 +0800 CST ExitCode:0 Hash:2101852810 HashWithoutResources:2673273670 RestartCount:0 Reason:Completed Message: Resources:map[CpuQuota:200000 Memory:2147483648 MemorySwap:2147483648]}
E1014 10:56:46.709255   34976 remote_runtime.go:250] RemoveContainer &quot;41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef&quot; from runtime service failed: rpc error: code = Unknown desc = failed to remove container &quot;41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef&quot;: Error response from daemon: container 41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef: driver &quot;overlay2&quot; failed to remove root filesystem: unlinkat /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged: device or resource busy
E1014 10:56:46.709292   34976 kuberuntime_gc.go:126] Failed to remove container &quot;41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef&quot;: rpc error: code = Unknown desc = failed to remove container &quot;41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef&quot;: Error response from daemon: container 41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef: driver &quot;overlay2&quot; failed to remove root filesystem: unlinkat /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged: device or resource busy</code></pre><p>日志显示kubelet处于Pod Terminating状态的原因很清楚：清理容器失败。</p>
<p>kubelet清理容器的命令是 <code>docker rm -f</code> ，其失败的原因在于删除容器目录 <code>xxx/merged</code> 时报错，错误提示为 <code>device or resource busy</code> 。</p>
<p>除此之外，kubelet无法再提供其他关键信息。</p>
<p>登陆宿主，我们验证对应容器的状态：</p>
<pre><code>1
2
3
4
5


[stupig@ hostname ~]$ sudo docker ps -a | grep pod-976a0-5
41020461ed4d            Removal In Progress                            k8s_stupig_pod-976a0-5_default_f1e03a3d-0dc7-11eb-b4b1-246e967c4efc_0
f0a75e10b252            Exited (0) 2 minutes ago                       k8s_POD_pod-976a0-5_default_f1e03a3d-0dc7-11eb-b4b1-246e967c4efc_0
[stupig@ hostname ~]$ sudo docker rm -f 41020461ed4d
Error response from daemon: container 41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef: driver &quot;overlay2&quot; failed to remove root filesystem: unlinkat /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged: device or resource busy</code></pre><p>问题已然清楚，现在我们有两种排查思路：</p>
<ul>
<li>参考Google上解决 <code>device or resource busy</code> 问题的思路</li>
<li>结合现象分析代码</li>
</ul>
<h4 id="2-2-Google大法"><a href="#2-2-Google大法" class="headerlink" title="2.2 Google大法"></a>2.2 Google大法</h4><p>有问题找Google！所以，我们首先咨询了Google，检索结果显示很多人都碰到了类似的问题。</p>
<p>而网络上主流的解决方案：配置docker服务MountFlags为slave，避免docker挂载点信息泄漏到其他mnt命名空间，详细原因请参阅：<a href="https://blog.terminus.io/docker-device-is-busy/" target="_blank" rel="noopener">docker device busy问题解决方案</a>。</p>
<p>这么简单？？？显然不能，检查发现docker服务当前已配置MountFlags为slave。网络银弹再次失去功效。</p>
<p>so，我们还是老老实实结合现场分析代码吧。</p>
<h4 id="2-3-docker处理流程"><a href="#2-3-docker处理流程" class="headerlink" title="2.3 docker处理流程"></a>2.3 docker处理流程</h4><p>在具体分析docker代码之前，先简单介绍下docker的处理流程，避免作为一只无头苍蝇处处碰壁。</p>
<p><img src="https://www.likakuli.com/svg/loading.min.svg" alt="/posts/docker-pod-terminating/docker-process.png"></p>
<p>清楚了docker的处理流程之后，我们再来分析现场。</p>
<h4 id="2-4-提审docker"><a href="#2-4-提审docker" class="headerlink" title="2.4 提审docker"></a>2.4 提审docker</h4><p>问题发生在docker清理阶段，docker清理容器读写层出错，报错信息为 <code>device or resource busy</code>，说明docker读写层并没有被正确卸载，或者是没有完全卸载。下面的命令可以验证这个结论：</p>
<pre><code>1
2
3
4
5


[stupig@ hostname ~]$ grep -rwn &apos;/home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged&apos; /proc/*/mountinfo
/proc/22283/mountinfo:50:386 542 0:92 / /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX
/proc/22407/mountinfo:50:386 542 0:92 / /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX
/proc/28454/mountinfo:50:386 542 0:92 / /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX
/proc/28530/mountinfo:50:386 542 0:92 / /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX</code></pre><p>不出所料，容器读写层仍然被以上四个进程所挂载，进而导致docker在清理读写层目录时报错。</p>
<p>随之而来的问题是，为什么docker没有正确卸载容器读写层？我们先展示下 <code>docker stop</code> 中卸载容器读写层挂载的相关部分代码：</p>
<pre><code> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38


func (daemon *Daemon) Cleanup(container *container.Container) {
   if err := daemon.conditionalUnmountOnCleanup(container); err != nil {
      if mountid, err := daemon.imageService.GetLayerMountID(container.ID, container.OS); err == nil {
         daemon.cleanupMountsByID(mountid)
      }
   }
}
func (daemon *Daemon) conditionalUnmountOnCleanup(container *container.Container) error {
   return daemon.Unmount(container)
}
func (daemon *Daemon) Unmount(container *container.Container) error {
   if container.RWLayer == nil {
      return errors.New(&quot;RWLayer of container &quot; + container.ID + &quot; is unexpectedly nil&quot;)
   }
   if err := container.RWLayer.Unmount(); err != nil {
      logrus.Errorf(&quot;Error unmounting container %s: %s&quot;, container.ID, err)
      return err
   }

   return nil
}
func (rl *referencedRWLayer) Unmount() error {
   return rl.layerStore.driver.Put(rl.mountedLayer.mountID)
}
func (d *Driver) Put(id string) error {
   d.locker.Lock(id)
   defer d.locker.Unlock(id)
   dir := d.dir(id)
   mountpoint := path.Join(dir, &quot;merged&quot;)
   logger := logrus.WithField(&quot;storage-driver&quot;, &quot;overlay2&quot;)
   if err := unix.Unmount(mountpoint, unix.MNT_DETACH); err != nil {
      logger.Debugf(&quot;Failed to unmount %s overlay: %s - %v&quot;, id, mountpoint, err)
   }
   if err := unix.Rmdir(mountpoint); err != nil &amp;&amp; !os.IsNotExist(err) {
      logger.Debugf(&quot;Failed to remove %s overlay: %v&quot;, id, err)
   }
   return nil
}</code></pre><p>代码处理流程清晰明了，最终docker会发起 <code>SYS_UMOUNT2</code> 系统调用卸载容器读写层。</p>
<p>但是，docker在清理容器读写层时却提示错误，并且容器读写层挂载信息也出现在其他进程中。难不成docker没有执行卸载操作？结合docker日志分析：</p>
<pre><code>1
2


Oct 14 10:50:28 hostname dockerd: time=&quot;2020-10-14T10:50:28.769199725+08:00&quot; level=debug msg=&quot;Failed to unmount e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5 overlay: /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged - invalid argument&quot; storage-driver=overlay2
Oct 14 10:50:28 hostname dockerd: time=&quot;2020-10-14T10:50:28.769213547+08:00&quot; level=debug msg=&quot;Failed to remove e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5 overlay: device or resource busy&quot; storage-driver=overlay2</code></pre><p>日志显示docker在执行卸载容器读写层命令时出错，提示 <code>invalid argument</code>。结合 <a href="https://man7.org/linux/man-pages/man2/umount.2.html" target="_blank" rel="noopener">umount2</a> 文档可知，容器读写层并非是dockerd（docker后台进程）的挂载点？？？</p>
<p>现在，回过头来分析拥有容器读写层挂载信息的进程，我们发现一个惊人的信息：</p>
<pre><code>1
2
3
4
5


[stupig@ hostname ~]$ ps -ef|grep -E &quot;22283|22407|28454|28530&quot;
root      22283      1  0 10:48 ?        00:00:00 docker-containerd-shim -namespace moby
root      22407      1  0 10:48 ?        00:00:00 docker-containerd-shim -namespace moby
root      28454      1  0 10:49 ?        00:00:00 docker-containerd-shim -namespace moby
root      28530      1  0 10:49 ?        00:00:00 docker-containerd-shim -namespace moby</code></pre><p>容器读写层挂载信息没有出现在dockerd进程命名空间中，却出现在其他容器的托管服务shim进程的命名空间内，推断dockerd进程发生了重启，对比进程启动时间与命名空间详情可以进行验证：</p>
<pre><code> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43


[stupig@ hostname ~]$ ps -eo pid,cmd,lstart|grep dockerd
 34836 /usr/bin/dockerd --storage- Wed Oct 14 10:50:15 2020

[stupig@ hostname ~]$ sudo ls -la /proc/$(pidof dockerd)/ns
lrwxrwxrwx 1 root root 0 Oct 14 10:50 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 mnt -&gt; mnt:[4026533327]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 net -&gt; net:[4026531968]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 pid -&gt; pid:[4026531836]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 uts -&gt; uts:[4026531838]

[stupig@ hostname ~]$ ps -eo pid,cmd,lstart|grep -w containerd|grep -v shim
 34849 docker-containerd --config  Wed Oct 14 10:50:15 2020

[stupig@ hostname ~]$ sudo ls -la /proc/$(pidof docker-containerd)/ns
lrwxrwxrwx 1 root root 0 Oct 14 10:50 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 mnt -&gt; mnt:[4026533327]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 net -&gt; net:[4026531968]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 pid -&gt; pid:[4026531836]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 uts -&gt; uts:[4026531838]

[stupig@ hostname ~]$ ps -eo pid,cmd,lstart|grep -w containerd-shim
 22283 docker-containerd-shim -nam Wed Oct 14 10:48:50 2020
 22407 docker-containerd-shim -nam Wed Oct 14 10:48:55 2020
 28454 docker-containerd-shim -nam Wed Oct 14 10:49:53 2020
 28530 docker-containerd-shim -nam Wed Oct 14 10:49:53 2020

[stupig@ hostname ~]$ sudo ls -la /proc/28454/ns
lrwxrwxrwx 1 root root 0 Oct 14 10:50 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 mnt -&gt; mnt:[4026533200]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 net -&gt; net:[4026531968]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 pid -&gt; pid:[4026531836]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0 Oct 14 10:50 uts -&gt; uts:[4026531838]

[stupig@ hostname ~]$ sudo ls -la /proc/$$/ns
lrwxrwxrwx 1 panpeilong panpeilong 0 Oct 14 21:49 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 panpeilong panpeilong 0 Oct 14 21:49 mnt -&gt; mnt:[4026531840]
lrwxrwxrwx 1 panpeilong panpeilong 0 Oct 14 21:49 net -&gt; net:[4026531968]
lrwxrwxrwx 1 panpeilong panpeilong 0 Oct 14 21:49 pid -&gt; pid:[4026531836]
lrwxrwxrwx 1 panpeilong panpeilong 0 Oct 14 21:49 user -&gt; user:[4026531837]
lrwxrwxrwx 1 panpeilong panpeilong 0 Oct 14 21:49 uts -&gt; uts:[4026531838]</code></pre><p>结果验证了我们推断的正确性。现在再补充下docker组件的进程树模型，用以解释这个现象，模型如下：</p>
<p><img src="https://www.likakuli.com/svg/loading.min.svg" alt="/posts/docker-pod-terminating/containerd-process-model.png"></p>
<p>dockerd进程启动时，会自动拉起containerd进程；当用户创建并启动容器时，containerd会启动containerd-shim进程用于托管容器进程，最终由containerd-shim调用runc启动容器进程。runc负责初始化进程命名空间，并exec容器启动命令。</p>
<p>上述模型中shim进程存在的意义是：允许dockerd/containerd升级或重启，同时不影响已运行容器。docker提供了 <code>live-restore</code> 的能力，而我们的集群也的确启用了该配置。</p>
<p>此外，由于我们在systemd的docker配置选项中配置了 <code>MountFlags=slave</code>，参考<a href="https://freedesktop.org/software/systemd/man/systemd.exec.html#MountFlags=" target="_blank" rel="noopener">systemd配置说明</a>，systemd在启动dockerd进程时，会创建一个新的mnt命名空间。</p>
<p>至此，问题已基本定位清楚：</p>
<ul>
<li>systemd在启动dockerd服务时，将dockerd安置在一个新的mnt命名空间中</li>
<li>用户创建并启动容器时，dockerd会在本mnt命名空间内挂载容器读写层目录，并启动shim进程托管容器进程</li>
<li>由于某种原因，dockerd服务发生重启，systemd会将其安置在另一个新的mnt命名空间内</li>
<li>用户删除容器时，容器退出时，dockerd在清理容器读写层挂载时报错，因为挂载并非在当前dockerd的mnt命名空间内</li>
</ul>
<p>后来，我们在docker issue中也发现了<a href="https://github.com/moby/moby/issues/35873#issuecomment-386467562" target="_blank" rel="noopener">官方给出的说明</a>，<code>MountFlags=slave</code> 与 <code>live-restore</code> 确实不能同时使用。</p>
<h4 id="2-5-一波又起"><a href="#2-5-一波又起" class="headerlink" title="2.5 一波又起"></a>2.5 一波又起</h4><p>还没当我们沉浸在解决问题的喜悦之中，另一个疑问接踵而来。我们线上集群好多宿主同时配置了 <code>MountFlags=slave</code> 和 <code>live-restore=true</code>，为什么问题直到最近才报出来呢？</p>
<p>当我们分析了几起 <code>Pod Terminating</code> 的涉事宿主后，发现它们的一个通性是docker版本为 <code>18.06.3-ce</code>，而我们当前主流的版本仍然是 <code>1.13.1</code>。</p>
<p>难道是新版本中才引入的问题？我们首先在测试环境中对 <code>1.13.1</code> 版本的docker进行了验证，Pod确实没有被阻塞在 Terminating 状态，这是不是说明低版本docker不存在挂载点泄漏的问题呢？</p>
<p>事实并非如此。当我们再次进行验证时，在删除Pod前记录了测试容器的读写层，之后发送删除Pod指令，Pod顺利退出，但此时，我们登录Pod之前所在宿主，发现docker日志中同样也存在如下日志：</p>
<pre><code>1


Oct 14 22:12:43 hostname2 dockerd: time=&quot;2020-10-14T22:12:43.730726978+08:00&quot; level=debug msg=&quot;Failed to unmount fb41efa2cfcbfbb8d90bd1d8d77d299e17518829faf52af40f7a1552ec8aa165 overlay: /home/docker_rt/overlay2/fb41efa2cfcbfbb8d90bd1d8d77d299e17518829faf52af40f7a1552ec8aa165/merged - invalid argument&quot;</code></pre><p>同样存在卸载问题的情况下，高低版本的docker却呈现出了不同的结果，这显然是docker的处理逻辑发生了变更，这里我们对比源码能够很快得出结论：</p>
<pre><code> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71


// 1.13.1 版本处理逻辑
func (daemon *Daemon) cleanupContainer(container *container.Container, forceRemove, removeVolume bool) (err error) {
   // If force removal is required, delete container from various
   // indexes even if removal failed.
   defer func() {
      if err == nil || forceRemove {
         daemon.nameIndex.Delete(container.ID)
         daemon.linkIndex.delete(container)
         selinuxFreeLxcContexts(container.ProcessLabel)
         daemon.idIndex.Delete(container.ID)
         daemon.containers.Delete(container.ID)
         if e := daemon.removeMountPoints(container, removeVolume); e != nil {
            logrus.Error(e)
         }
         daemon.LogContainerEvent(container, &quot;destroy&quot;)
      }
   }()

   if err = os.RemoveAll(container.Root); err != nil {
      return fmt.Errorf(&quot;Unable to remove filesystem for %v: %v&quot;, container.ID, err)
   }

   // When container creation fails and `RWLayer` has not been created yet, we
   // do not call `ReleaseRWLayer`
   if container.RWLayer != nil {
      metadata, err := daemon.layerStore.ReleaseRWLayer(container.RWLayer)
      layer.LogReleaseMetadata(metadata)
      if err != nil &amp;&amp; err != layer.ErrMountDoesNotExist {
         return fmt.Errorf(&quot;Driver %s failed to remove root filesystem %s: %s&quot;, daemon.GraphDriverName(), container.ID, err)
      }
   }

   return nil
}


// 18.06.3-ce 版本处理逻辑
func (daemon *Daemon) cleanupContainer(container *container.Container, forceRemove, removeVolume bool) (err error) {
   // When container creation fails and `RWLayer` has not been created yet, we
   // do not call `ReleaseRWLayer`
   if container.RWLayer != nil {
      err := daemon.imageService.ReleaseLayer(container.RWLayer, container.OS)
      if err != nil {
         err = errors.Wrapf(err, &quot;container %s&quot;, container.ID)
         container.SetRemovalError(err)
         return err
      }
      container.RWLayer = nil
   }

   if err := system.EnsureRemoveAll(container.Root); err != nil {
      e := errors.Wrapf(err, &quot;unable to remove filesystem for %s&quot;, container.ID)
      container.SetRemovalError(e)
      return e
   }

   linkNames := daemon.linkIndex.delete(container)
   selinuxFreeLxcContexts(container.ProcessLabel)
   daemon.idIndex.Delete(container.ID)
   daemon.containers.Delete(container.ID)
   daemon.containersReplica.Delete(container)
   if e := daemon.removeMountPoints(container, removeVolume); e != nil {
      logrus.Error(e)
   }
   for _, name := range linkNames {
      daemon.releaseName(name)
   }
   container.SetRemoved()
   stateCtr.del(container.ID)
   return nil
}</code></pre><p>改动一目了然，官方在<a href="https://github.com/moby/moby/pull/31012" target="_blank" rel="noopener">清理容器变更</a>中给出了详细的说明。也即在低版本docker中，问题并非不存在，仅仅是被隐藏了，并在高版本中被暴露出来。</p>
<h3 id="3-问题影响"><a href="#3-问题影响" class="headerlink" title="3. 问题影响"></a>3. 问题影响</h3><p>既然所有版本的docker都存在这个问题，那么其影响是什么呢？</p>
<p>在高版本docker中，其影响是显式的，会引起容器清理失败，进而造成Pod删除失败。</p>
<p>而在低版本docker中，其影响是隐式的，造成挂载点泄漏，进而可能会造成的影响如下：</p>
<ul>
<li>inode被打满：由于挂载点泄漏，容器读写层不会被清理，长时间累计可能会造成inode耗尽问题，但是是小概率事件</li>
<li>容器ID复用：由于挂载点未被卸载，当docker复用了原来已经退出的容器ID时，在挂载容器init层与读写层时会失败。由于docker生成容器ID是随机的，因此也是小概率事件</li>
</ul>
<h3 id="4-解决方案"><a href="#4-解决方案" class="headerlink" title="4. 解决方案"></a>4. 解决方案</h3><p>问题已然明确，如何解决问题成了当务之急。思路有二：</p>
<ol>
<li>治标：对标 <code>1.13.1</code> 版本的处理逻辑，修改 <code>18.06.3-ce</code> 处理代码</li>
<li>治本：既然官方也提及 <code>MountFlags=slave</code> 与 <code>live-restore</code> 不能同时使用，那么我们修改两个配置选项之一即可</li>
</ol>
<p>考虑到 <strong>重启docker不重启容器</strong> 这样一个强需求的存在，似乎我们唯一的解决方案就是关闭 <code>MountFlags=slave</code> 配置。关闭该配置后，与之而来的疑问如下：</p>
<ul>
<li>能够解决本问题？</li>
<li>网传其他systemd托管服务启用PrivateTmp是否会造成挂载点泄漏？</li>
</ul>
<p>欲知后事如何，且听下回分解！</p>
<p>赞赏支持</p>
<p> <img src="https://www.likakuli.com/media/reward/wechat.jpg" alt=""> 微信打赏</p>
<p>更新于 2020-11-04</p>
<p><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener"></a></p>
<p> <a href="https://www.likakuli.com/tags/docker/" target="_blank" rel="noopener">docker</a></p>
<p><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener">返回</a> | <a href="https://www.likakuli.com/" target="_blank" rel="noopener">主页</a></p>
<p><a href="https://www.likakuli.com/posts/docker-hang/" target="_blank" rel="noopener">docker hang问题排查</a> <a href="https://www.likakuli.com/posts/docker-pod-terminating2/" target="_blank" rel="noopener">Pod terminating2</a></p>
<p>Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/" target="_blank" rel="noopener">Valine</a>.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/fetched/" rel="tag"># fetched</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/17/qiwihui-pocket_readings-1047/" rel="prev" title="Pod terminating2">
      <i class="fa fa-chevron-left"></i> Pod terminating2
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/19/qiwihui-pocket_readings-1050/" rel="next" title="计算机领域的三个重要思想：抽象，分层和高阶">
      计算机领域的三个重要思想：抽象，分层和高阶 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Comments"><span class="nav-number">1.</span> <span class="nav-text">Comments</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod-terminating"><span class="nav-number"></span> <span class="nav-text">Pod terminating</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pod-terminating-1"><span class="nav-number"></span> <span class="nav-text">Pod terminating</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-背景"><span class="nav-number">1.</span> <span class="nav-text">1. 背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-抽丝剥茧"><span class="nav-number">2.</span> <span class="nav-text">2. 抽丝剥茧</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-排除kubelet嫌疑"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 排除kubelet嫌疑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-Google大法"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Google大法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-docker处理流程"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 docker处理流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-提审docker"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 提审docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-一波又起"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 一波又起</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-问题影响"><span class="nav-number">3.</span> <span class="nav-text">3. 问题影响</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-解决方案"><span class="nav-number">4.</span> <span class="nav-text">4. 解决方案</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">qiwihui</p>
  <div class="site-description" itemprop="description">个人阅读清单记录博客，并不代表个人观点。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qiwihui</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
